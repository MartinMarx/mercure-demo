{% extends('base.html.twig') %}

{% block body %}
    <div class="wrap">
        <div class="container">
            <h1>Démo – Mercure</h1>
            <div id="messages">
                {% for message in messages %}
                    <div class="item {{ message.sender == username ? 'out' : 'in' }}">
                        <div class="body">
                            <p class="content">{{ message.text }}</p>
                            <p class="datetime">{{ message.dateSent|format_datetime() }}</p>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <form onsubmit="return submitMessage();">
                <input autofocus type="text" placeholder="Nouveau message..." id="message-input">
                <button type="submit">Envoyer</button>
            </form>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script>
        {#const eventSource = new EventSource("{{ mercure(schema_url)|escape('js') }}");#}
        {#eventSource.onmessage = event => {#}
        {#    const data = JSON.parse(event.data)#}
        {#    console.table(data);#}

        {#    appendMessageToDom(data)#}
        {#}#}

        async function pushMessage(data) {
            await fetch('{{ path("mercure_publish") }}', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({text: data, username: "{{ username }}"})
            });
        }

        function submitMessage() {
            const input = document.getElementById('message-input')
            pushMessage(input.value)
            input.value = ''
            return false;
        }
    </script>
{% endblock %}
